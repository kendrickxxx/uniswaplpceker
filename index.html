<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Uniswap V3 – Position & Reward Checker</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f7;
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
    }
    .card {
      width: 100%;
      max-width: 640px;
      background: #ffffff;
      border-radius: 16px;
      padding: 24px 20px 28px;
      box-shadow: 0 18px 35px rgba(15, 23, 42, 0.12);
    }
    h1 {
      font-size: 22px;
      margin: 0 0 6px;
    }
    .subtitle {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 18px;
    }
    label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      margin-top: 12px;
      margin-bottom: 4px;
    }
    select,
    input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      outline: none;
      transition: border 0.15s, box-shadow 0.15s, background 0.15s;
      background: #f9fafb;
    }
    select:focus,
    input:focus {
      border-color: #6366f1;
      box-shadow: 0 0 0 1px rgba(99, 102, 241, 0.3);
      background: #ffffff;
    }
    .hint {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 2px;
    }
    .or {
      margin: 14px 0 4px;
      text-align: center;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      color: #9ca3af;
      position: relative;
    }
    .or::before,
    .or::after {
      content: "";
      position: absolute;
      top: 50%;
      width: 40%;
      height: 1px;
      background: #e5e7eb;
    }
    .or::before {
      left: 0;
    }
    .or::after {
      right: 0;
    }
    button {
      margin-top: 18px;
      width: 100%;
      padding: 10px 14px;
      border-radius: 999px;
      border: none;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      background: #6366f1;
      color: #ffffff;
      box-shadow: 0 10px 20px rgba(79, 70, 229, 0.35);
      transition: transform 0.12s, box-shadow 0.12s, background 0.12s;
    }
    button:hover {
      background: #4f46e5;
      box-shadow: 0 12px 25px rgba(79, 70, 229, 0.45);
      transform: translateY(-1px);
    }
    button:active {
      transform: translateY(0);
      box-shadow: 0 6px 14px rgba(79, 70, 229, 0.35);
    }
    pre {
      margin-top: 20px;
      background: #020617;
      color: #c7f39b;
      padding: 14px 12px;
      border-radius: 10px;
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      overflow-x: auto;
      border: 1px solid #111827;
    }
    .badge-row {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 6px;
      margin-bottom: 4px;
    }
    .badge {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #eef2ff;
      color: #4338ca;
      font-weight: 500;
    }
    .badge.secondary {
      background: #ecfeff;
      color: #0e7490;
    }
    .footer {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 10px;
    }
    .footer strong {
      color: #6b7280;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Uniswap V3 – Position &amp; Reward Checker</h1>
    <p class="subtitle">
      Masukkan <strong>Token ID</strong> NFT posisi, atau kombinasi <strong>Pool CA + Wallet</strong> untuk cek
      apakah masih ada liquidity &amp; reward yang belum di-claim (tokensOwed).
    </p>

    <div class="badge-row">
      <span class="badge">Uniswap V3</span>
      <span class="badge secondary">Ethereum · Arbitrum · Optimism · Polygon · Base</span>
    </div>

    <label for="chain">Chain</label>
    <select id="chain">
      <option value="ethereum">Ethereum</option>
      <option value="arbitrum">Arbitrum One</option>
      <option value="optimism">Optimism</option>
      <option value="polygon">Polygon PoS</option>
      <option value="base">Base</option>
    </select>

    <label for="tokenId">Token ID (NFT position id)</label>
    <input id="tokenId" placeholder="contoh: 366200" />
    <div class="hint">Mode 1 – langsung cek 1 posisi berdasarkan Token ID.</div>

    <div class="or">atau</div>

    <label for="poolAddr">Pool Address (CA)</label>
    <input id="poolAddr" placeholder="0x… address token0 atau token1 pool" />
    <label for="walletAddr">Wallet Address</label>
    <input id="walletAddr" placeholder="0x… address pemilik posisi" />
    <div class="hint">
      Mode 2 – scan semua NFT LP milik wallet di NonfungiblePositionManager, lalu filter yang terkait pool ini.
      (Kalau wallet punya banyak posisi, bisa agak lama.)
    </div>

    <button id="checkBtn">Check Position</button>

    <pre id="result">Result akan muncul di sini…</pre>

    <div class="footer">
      <strong>Tip:</strong> Token amount di output masih dalam satuan raw (belum dibagi decimals).
      Untuk nilai fiat / human readable perlu tambahan call ke kontrak token &amp; price feed.
    </div>
  </div>

  <!-- ethers.js -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script>
    // NonfungiblePositionManager address – sama di banyak chain EVM tempat Uniswap V3 dideploy.
    const NFPM_ADDRESSES = {
      ethereum: "0xC36442b4a4522E871399CD717aBDD847Ab11FE88",
      arbitrum: "0xC36442b4a4522E871399CD717aBDD847Ab11FE88",
      optimism: "0xC36442b4a4522E871399CD717aBDD847Ab11FE88",
      polygon:  "0xC36442b4a4522E871399CD717aBDD847Ab11FE88",
      base:     "0xC36442b4a4522E871399CD717aBDD847Ab11FE88",
    };

    // Auto RPC per chain (tanpa input manual)
    const AUTO_RPC = {
      ethereum: "https://rpc.ankr.com/eth",
      arbitrum: "https://arb1.arbitrum.io/rpc",
      optimism: "https://mainnet.optimism.io",
      polygon:  "https://polygon-rpc.com",
      base:     "https://developer-access-mainnet.base.org",
    };

    // ABI minimal NFPM v3: positions + enumerable (balanceOf, tokenOfOwnerByIndex)
    const NFPM_ABI = [
      "function positions(uint256 tokenId) view returns (" +
      "uint96 nonce," +
      "address operator," +
      "address token0," +
      "address token1," +
      "uint24 fee," +
      "int24 tickLower," +
      "int24 tickUpper," +
      "uint128 liquidity," +
      "uint256 feeGrowthInside0LastX128," +
      "uint256 feeGrowthInside1LastX128," +
      "uint128 tokensOwed0," +
      "uint128 tokensOwed1" +
      ")",
      "function balanceOf(address owner) view returns (uint256)",
      "function tokenOfOwnerByIndex(address owner, uint256 index) view returns (uint256)"
    ];

    const chainLabels = {
      ethereum: "Ethereum",
      arbitrum: "Arbitrum One",
      optimism: "Optimism",
      polygon:  "Polygon PoS",
      base:     "Base",
    };

    async function checkPosition() {
      const chain    = document.getElementById("chain").value;
      const tokenId  = document.getElementById("tokenId").value.trim();
      const poolAddr = document.getElementById("poolAddr").value.trim();
      const wallet   = document.getElementById("walletAddr").value.trim();
      const resultEl = document.getElementById("result");

      const nfpmAddress = NFPM_ADDRESSES[chain];
      const rpcUrl = AUTO_RPC[chain];

      if (!nfpmAddress) {
        resultEl.textContent = "Alamat NonfungiblePositionManager untuk chain ini belum di-set.";
        return;
      }
      if (!rpcUrl) {
        resultEl.textContent = "RPC untuk chain ini belum di-set.";
        return;
      }

      if (!tokenId && !(poolAddr && wallet)) {
        resultEl.textContent = "Masukkan Token ID, atau Pool Address + Wallet Address.";
        return;
      }

      resultEl.textContent = "⏳ Query on-chain…";

      try {
        const provider = new ethers.providers.JsonRpcProvider(rpcUrl);
        const nfpm = new ethers.Contract(nfpmAddress, NFPM_ABI, provider);

        // MODE 1: langsung Token ID
        if (tokenId) {
          const pos = await nfpm.positions(tokenId);

          const liquidity   = pos.liquidity;
          const tokensOwed0 = pos.tokensOwed0;
          const tokensOwed1 = pos.tokensOwed1;

          const data = {
            mode: "TOKEN_ID",
            chain: chainLabels[chain] || chain,
            tokenId: tokenId,
            token0: pos.token0,
            token1: pos.token1,
            feeTier: pos.fee.toString(),
            tickLower: pos.tickLower.toString(),
            tickUpper: pos.tickUpper.toString(),
            liquidity: liquidity.toString(),
            hasLiquidity: liquidity.gt(0),
            tokensOwed0: tokensOwed0.toString(),
            tokensOwed1: tokensOwed1.toString(),
            hasUnclaimedRewards: tokensOwed0.gt(0) || tokensOwed1.gt(0),
          };

          resultEl.textContent = JSON.stringify(data, null, 2);
          return;
        }

        // MODE 2: Pool + Wallet
        const balance = await nfpm.balanceOf(wallet);
        const count = balance.toNumber();

        if (count === 0) {
          resultEl.textContent = "Wallet ini tidak punya NFT posisi Uniswap V3 di NFPM.";
          return;
        }

        const poolLower = poolAddr.toLowerCase();
        const matches = [];

        for (let i = 0; i < count; i++) {
          const id = await nfpm.tokenOfOwnerByIndex(wallet, i);
          const pos = await nfpm.positions(id);

          const t0 = pos.token0.toLowerCase();
          const t1 = pos.token1.toLowerCase();

          if (t0 === poolLower || t1 === poolLower) {
            const liq = pos.liquidity;
            const owed0 = pos.tokensOwed0;
            const owed1 = pos.tokensOwed1;

            matches.push({
              tokenId: id.toString(),
              token0: pos.token0,
              token1: pos.token1,
              feeTier: pos.fee.toString(),
              tickLower: pos.tickLower.toString(),
              tickUpper: pos.tickUpper.toString(),
              liquidity: liq.toString(),
              hasLiquidity: liq.gt(0),
              tokensOwed0: owed0.toString(),
              tokensOwed1: owed1.toString(),
              hasUnclaimedRewards: owed0.gt(0) || owed1.gt(0),
            });
          }
        }

        if (matches.length === 0) {
          resultEl.textContent = "Tidak ditemukan posisi untuk pool + wallet ini.";
        } else {
          const payload = {
            mode: "POOL_AND_WALLET",
            chain: chainLabels[chain] || chain,
            pool: poolAddr,
            wallet: wallet,
            totalMatches: matches.length,
            positions: matches,
          };
          resultEl.textContent = JSON.stringify(payload, null, 2);
        }
      } catch (err) {
        console.error(err);
        resultEl.textContent =
          "❌ Error: " + (err.reason || err.message || String(err));
      }
    }

    document.getElementById("checkBtn").addEventListener("click", checkPosition);
  </script>
</body>
</html>
